notifications:
  email: false
sudo: enabled
os: linux
language: python
cache: pip
python: 3.8-dev
services:
  - docker

env:
  global:
  - GH_REPO=Drakkar-Software/OctoBot-Commons
  - REPO_NAME=OctoBot-Commons
  - DEPLOY_BRANCH=master
  - PACKAGE_FOLDER=octobot_commons
  - secure: TmpsYNuKqmHtiRcs+2DBxqwMuI3yLgnWgTLEHsg2YrRJ9v7h1zx6ynIN3/nEtBjc2S4Y0Opwhi/tTgtnwfVp4sgAPp0JETIZ8JQ+8bhxEBXUrgZNgHE4a72GxzsSjCpb/7HLoXSxwR4sYjnyw33FJzrY1/8V/PuOfZjN2btGbK6dM6fepIheK6IaYub6cj7P5sRKJz9tGDuK4IBekfhtxECQqk3S/LAwbmm/sXnCfJ5T7NKglpYLmMr1uAUUgUwKlQ7rHDMvdwvX+1gO3lWMwv2Dx4Wdgl58UvyaUIVD/Q29Z7ZL50hauwOrl6a4z6k61RGpBYY1sCwnjTNNMiNheWkMZAYahmJdY4Z7uWTNiluHsfp173j2lqYphIr7W/f+dc4nbms9oZvyGYnrJB/Fbl9To1NXj51XEy9PdGgympkj36D41o8MMCD4HSNrtfOPyBuPZGLFe6prd0jv/NxTKYNg4YXSMM8GQtH6wo9a82eip+JOSAwmg0KsScRksrn/sPz6LsPI6kY4+vA5Ruw2YtTFpg/rjWf2lMMA/ES1JxMecqqzS5EVvRtjMBNObYZll0s+7/yhT3a5AYoHd3OvJsONkIMQlpxB9x4n5jlmzPb7SIhKTIvalZsD4nbHVNUF1iUrhYhoajKdtN03Cpeh4BgcOFuobCniM/RJx9P7AhU=
  - secure: gGDIKPSLK2cb5aY4uCHDxnBLFwsZUZTjzRNejdAtJ6tlX7j8z5sA5ClD5aMu/bfWEnREtYNqU1ZGdrq3J6YeAIYPGJpUJZZ2dxkufodms1ObCT08LZ9RZpqV06RblFhqLBxF8X6u/Ip2xUm4bbuaHAO1nQ9TUUinFEgLbECVdVUy9iBmNFEJcKgQo42BTN7YoFxTwbIUC036hiflqs+mxR81Xhl/LTM5bVtDfIF5mQumQMDPEjPI1UCAN+vIBLgmRDbsJJ5BFt6GZuWLdCMzlDdGVV3rb6C6yx2FKBbzn7x3KRFjG726/TRFcme/uJivbGikYXVj+HQQermOX2KrNY8WP/JfoGxrlzx4DdflAtPTN9lfiLX3bYQ2VX3U5/RzLybK2sDXXGZ6O2V93sUMj73Bkf4QdDfqNI4zYiw26+T9rXpnoCj7aG0MzRWOZ8+K4oHlB8l7Pc3b6AF6/EIyJnMZzjRqXBjZOwqf1L0ZDduClYT2v/vKN5jst/DVxWPyTMyHD8hI8g/sCsRGZL9XXPF+L2N7QMVwgDVJpdnNNUkFqH4lWsDWaCZEhJR9y7sDVy2XGpwlG77gZmHPU+MCHyfOZilLUYcjoO1pwSEspTAkEw9/es8Zc0oM3f8BCuj5etutC4VemQGlnHVmxNzZOlJvpLBtkDtysDNnLUU8cow=

install:
  - python3 -m pip install --prefer-binary -r dev_requirements.txt -r requirements.txt

matrix:
  include:
  - name: "Linux - Python 3.8-dev - Python sources"
    stage: test
    os: linux
    python: 3.8-dev
    language: python
    script:
      - pytest --cov=. --cov-config=.coveragerc --durations=0 -rw tests
    after_success:
      - if [ $TRAVIS_PULL_REQUEST == "false" ]; then coveralls; fi

  - name: "Linux - Python 3.8-dev - Installed"
    stage: test
    os: linux
    python: 3.8-dev
    language: python
    script:
      - python3 setup.py install
      - rm -rf $PACKAGE_FOLDER
      - pytest tests

  - name: "OSX - Python 3.7-dev - Installed"
    stage: test
    os: osx
    osx_image: xcode11    # Python 3.7.2 running on macOS 10.14.3
    language: shell       # 'language: python' is an error on Travis CI macOS
    # python: 3.7         # 'python:' is ignored on Travis CI macOS
    before_install: python3 --version ; pip3 --version ; sw_vers
    before_cache:
      - rm -f "$HOME/Library/Caches/pip/log/debug.log"
    cache:
      directories:
        - "$HOME/Library/Caches/pip"
    script:
      - python3 setup.py build_ext --inplace
      - python3 setup.py install
      - rm -rf $PACKAGE_FOLDER
      - pytest tests

deploy:
  - provider: pypi
    user:
      secure: Z+/pkPOu5iJTBkuROtL5URWC9XQnV3j/8VpacsTjSRwBHJ6OO1aJrncYM1rUTLReZqXXkEnZ9WJY/9VOCMoAEApwvx1Qo8aYDfwSi5U0XALyqmncleFKDNj5uTGNIhPEB2y8W5jz9uh3tCFJvkVC4JbyqDQ/VoTJQtkYNDnhYNONoprRSntiQP+pwc9G2hVVFzUcH67oAe0RxYLBPEETNdIrNEj3Qcab3Bq/CoHYPTqSOnJPan1/+9+xux51ZRV9W1mn7ITjwFSkNm+7EyGK6iUBnTc248xRW9Z+36q71JSxe5QgV5ovdKBItuJqnS9VrZMkS0KWaB79pAUKFoXIyDvBG6n3V/5Iha0j3JX5CBZJI35RZ7wZJ5otfkQVajxKTeA9nRuiSTrZhZ35DaJdeZEhN4D59lD0Bz3h3srNJ1tACmNc7r0VLycCpDyyQM2x+TaWGlwoiwXrEMaQgyql+LuSqtJ5MKO1delkZqhJ/F+exICVRT7kDiiePQGBbJhXoh3ytdORGL2KIBxdqZBcIbpgs1crCp4uolQuE/IvdxqBnvjNIR9TQYGegAbv1x8GNpma5VgTTYp98MLinjiA/VMm2GSjJH1DLjNjbf+s3VsISrbeiYK3HGJdCszi+cUEVnERZleazmpzf1Y5a2NvoRQBh67LwWhDWgzrDTNMTLQ=
    password:
      secure: AOF1hWVNX8tPEsOx2//OWq7ElyAMsCkRgRA7ji1G0yiiTUIwnSJRLbDHkDb3SzXv1COWfmbfSwuAvpaRQIRmADL1PdLRGyFpd1q2Qpsj3f0H9kGlN4+DZkfwRQY/MLhQoOI+J8GGLJLmCXJD8h/7OmuAdfww5CaJUlGIT5CIZkM6kPSdyk92qfekWsKQRYieDJFCh2WALUHXUVDwutYeVVg/JTV9mNk0x4Apmy00ZSvSJW+ux3QckjAYIlVyoTCYSkufW1ADOdsZiMZaY88Y+Tr2lab1wKCZ/wNrzhWBcH3bJrkpdQqOBW99omV1Z1vgRRAurplzrDapezULWP9lhjQRnhmBYhTdVarB6WQvaTrqIMoLvzFKGB01MVKcfLmbPckJUmhRRfQ55G7DdVfkaZ8SQxO4YKtdySAdioehPlQIAd3ZLrUXkngewCwEDUbkBuaool3h8nueypvD7R4QcNR4EnmDrNy0QS0GztjairzOQu8wpeOvpphe6VP8wqKkS3OT9CJ3vWYcqWodvK7UmXGSXVaoZ00RV/f6jlPNcXs/5Ls8+MV2UGwfM6U860AG8BI4W5QcPk3oX27PN0ByL1wsssf6B7+RETmPq9ayuQZDqs8VXFYWbzPdvfbES8f8iHyLgB0SP8sm0rSak71r9k7JvthmiMPWuh6zq4gyINU=
    skip_existing: true
    skip_cleanup: true
    distributions: sdist
    on:
      repo: "$GH_REPO"
      branch: "$DEPLOY_BRANCH"
      tags: true
      condition: "$TRAVIS_OS_NAME = 'linux'"
  - provider: script
    script: docker run -it -e PYPI_USERNAME=$PYPI_USERNAME -e PYPI_PASSWORD=$PYPI_PASSWORD -v $(pwd):/project drakkarsoftware/octobot-pypi-deploy:i686 "i686" "cp37-cp37m" "cp37"
    skip_cleanup: true
    on:
      repo: "$GH_REPO"
      branch: "$DEPLOY_BRANCH"
      tags: true
      condition: "$TRAVIS_OS_NAME = 'linux'"
  - provider: script
    script: docker run -it -e PYPI_USERNAME=$PYPI_USERNAME -e PYPI_PASSWORD=$PYPI_PASSWORD -v $(pwd):/project drakkarsoftware/octobot-pypi-deploy:x86_64 "x86_64" "cp37-cp37m" "cp37"
    skip_cleanup: true
    on:
      repo: "$GH_REPO"
      branch: "$DEPLOY_BRANCH"
      tags: true
      condition: "$TRAVIS_OS_NAME = 'linux'"
  - provider: script
    script: python3 setup.py bdist_wheel && python3 -m twine upload dist/* -u $PYPI_USERNAME -p $PYPI_PASSWORD --skip-existing
    skip_cleanup: true
    on:
      repo: "$GH_REPO"
      branch: "$DEPLOY_BRANCH"
      tags: true
      condition: "$TRAVIS_OS_NAME = 'osx'"
