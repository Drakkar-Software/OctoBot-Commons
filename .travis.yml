notifications:
  email: false
os: linux
dist: xenial
language: python
cache: pip
python: 3.8-dev
services:
  - docker

env:
  global:
  - GH_REPO=Drakkar-Software/OctoBot-Commons
  - REPO_NAME=OctoBot-Commons
  - DEPLOY_BRANCH=master
  - PACKAGE_FOLDER=octobot_commons

install:
  - python3 -m pip install --prefer-binary -r dev_requirements.txt -r requirements.txt

stages:
  - compile
  - deploy
  - notify

jobs:
  include:
  - name: "Linux - Python 3.8-dev - Python sources"
    stage: test
    os: linux
    python: 3.8-dev
    language: python
    script:
      - pytest --cov=. --cov-config=.coveragerc --durations=0 -rw tests
    after_success:
      - if [ $TRAVIS_PULL_REQUEST == "false" ]; then coveralls; fi

  - name: "Linux amd64 - Python 3.8-dev - Installed"
    stage: test
    os: linux
    python: 3.8-dev
    language: python
    script:
      - export CYTHON_IGNORE=true
      - python3 setup.py install
      - rm -rf $PACKAGE_FOLDER
      - pytest tests

  - name: "Linux - Python 3.8-dev - Lint"
    stage: test
    os: linux
    language: python
    script:
      - black $PACKAGE_FOLDER --diff --check
      - pylint --rcfile=standard.rc $PACKAGE_FOLDER
      - if [ $? -ne 1 ]; then exit 0; fi

deploy:
  - provider: pypi
    username: __token__
    password:
      secure: mN1PMavqZ8+NXnxMbCiEYfFP07EMhX6BXXK4XtXtu21c1s3GW4C7ePQ/as0EUZRFyAzP6nRdFlAIYKrbmbC0WHn8Rr9WQEHK3gurpEYbLRERv3q9hfS36bN+2DmvqHcUG8/EOywf9Ut/hunc8ikvt3+DpR37+JGAzI1Ln3sFXWWYtyL8atkdiVsozsuzFFA/TDScD5ICwYqiNWhve1bnLfM5uooXF/ehwk339KYsiyaUJw8roAToAW7k8o4vxuz8G2DImoKl5rv4kLzI4svoH1S035dS0U0cx0oloE1rxP+nQTUisX02QuRknfojfwZ5xRqmTydi1wo80NBJS/HS7WXJSFFn6v9jZ1KvphJBkdNxQt/fCaWjU09h7Lu1CyWc5VQ0kNZ2ia5RifQz8IhUz/j0qd39tQEQGq3UE9NHV6m4jdYg7Weef6HNnGU5ys+YWWHVgO6G5qVO40Vvqif6pVSZcWK2/IAQS57Pnov0ZjoXEcTxzOvXTEJwmy51QQ9wHL0BjZy0HPcPQkuTWoLCvHYXYBPcBX/dJlRkTrauKKVs/cY4bVZNAkqHll7CH4TwYLRn2PD93+N7FjyUuz9Fp8eQs7zTizZ+plh2dHGhoULKX66Vnc3wRVQU8AR7e5ZZr45/4D2RlzYIkUCaUGTO7IjU34HF5vuwnrE7eV3aj2E=
    skip_existing: true
    cleanup: true
    distributions: sdist
    on:
      repo: "$GH_REPO"
      branch: "$DEPLOY_BRANCH"
      tags: true
  - provider: script
    script: docker run -it -e PYPI_USERNAME=$PYPI_USERNAME -e PYPI_PASSWORD=$PYPI_PASSWORD -v $(pwd):/project drakkarsoftware/pypi-builder:manylinux-i686
    cleanup: true
    on:
      repo: "$GH_REPO"
      branch: "$DEPLOY_BRANCH"
      tags: true
  - provider: script
    script: docker run -it -e PYPI_USERNAME=$PYPI_USERNAME -e PYPI_PASSWORD=$PYPI_PASSWORD -v $(pwd):/project drakkarsoftware/pypi-builder:manylinux-x86_64
    cleanup: true
    on:
      repo: "$GH_REPO"
      branch: "$DEPLOY_BRANCH"
      tags: true

after_failure:
  - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
  - chmod +x send.sh
  - ./send.sh failure https://discordapp.com/api/webhooks/$WEBHOOK_TOKEN
